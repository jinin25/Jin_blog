---
import { getRelativeLocaleUrl } from "astro:i18n";
import { Temporal } from "temporal-polyfill";
import config, { monolocale } from "$config";
import type { Section } from "$utils/config";
import Time from "$utils/time";
import i18nit from "$i18n";
import { getFileGitHistory } from "$utils/git";
import path from "path";

/**
 * Content item structure
 */
interface ContentItem {
	id: string;
	data: {
		title: string;
		timestamp: Date;
	};
}

/**
 * Activity type
 */
type ActivityType = "create" | "modify";

/**
 * Content with activity information
 */
interface ContentWithActivity {
	section: Section;
	title: string;
	date: Temporal.PlainDate;
	link: string;
	activityType: ActivityType;
}

/**
 * Heatmap component props
 */
interface Props {
	locale: string;
	notes: ContentItem[];
	jottings: ContentItem[];
}

let { locale, notes, jottings } = Astro.props;

// Initialize translation function for current locale
const t = i18nit(locale);

// Temporary storage for processed content and heatmap cells
const contents: ContentWithActivity[] = [];
const cells: { target: string; contents: ContentWithActivity[] }[] = [];

// Determine heatmap frequency (default: day)
const frequency = config.heatmap?.unit || "day";
const now = Time().toPlainDate();

// Process notes with Git history
notes.forEach(note => {
	// note.id for zh-cn locale is like "zh-cn/paperreading-mllm1"
	const filePath = path.join(process.cwd(), "src", "content", "note", `${note.id}.md`);
	const gitHistory = getFileGitHistory(filePath);

	const link = getRelativeLocaleUrl(locale, `/note/${monolocale ? note.id : note.id.split("/").slice(1).join("/")}`);

	if (gitHistory.length > 0) {
		// Add all Git history entries (create and modify)
		gitHistory.forEach(history => {
			contents.push({
				section: "note",
				title: note.data.title,
				date: Time(history.date.toISOString()).toPlainDate(),
				link,
				activityType: history.type
			});
		});
	} else {
		// Fallback to timestamp if no Git history
		contents.push({
			section: "note",
			title: note.data.title,
			date: Time(note.data.timestamp.toISOString()).toPlainDate(),
			link,
			activityType: "create"
		});
	}
});

// Process jottings with Git history
jottings.forEach(jotting => {
	// jotting.id for zh-cn locale is like "zh-cn/some-jotting"
	const filePath = path.join(process.cwd(), "src", "content", "jotting", `${jotting.id}.md`);
	const gitHistory = getFileGitHistory(filePath);

	const link = getRelativeLocaleUrl(locale, `/jotting/${monolocale ? jotting.id : jotting.id.split("/").slice(1).join("/")}`);

	if (gitHistory.length > 0) {
		// Add all Git history entries (create and modify)
		gitHistory.forEach(history => {
			contents.push({
				section: "jotting",
				title: jotting.data.title,
				date: Time(history.date.toISOString()).toPlainDate(),
				link,
				activityType: history.type
			});
		});
	} else {
		// Fallback to timestamp if no Git history
		contents.push({
			section: "jotting",
			title: jotting.data.title,
			date: Time(jotting.data.timestamp.toISOString()).toPlainDate(),
			link,
			activityType: "create"
		});
	}
});

// Group content into heatmap cells based on the configured frequency
if (frequency === "month") {
	const { years = 4 } = config.heatmap?.unit === "month" ? config.heatmap : {};
	const start = Temporal.PlainDate.from({ year: now.year - years + 1, month: 1, day: 1 });
	const end = Temporal.PlainDate.from({ year: now.year, month: 12, day: 31 });

	let current = start;
	// Initialize month-based cells
	while (Temporal.PlainDate.compare(current, end) <= 0) {
		cells.push({
			target: current.toLocaleString(locale, { month: "short", year: "numeric" }),
			contents: []
		});
		current = current.add({ months: 1 });
	}

	// Distribute content into month-based cells
	contents.forEach(content => {
		const gap = start.until(content.date, { largestUnit: "month" }).months;
		if (gap >= 0 && gap < cells.length) cells[gap].contents.push(content);
	});
} else if (frequency === "week") {
	const start = now.subtract({ weeks: 51, days: now.dayOfWeek - 1 });

	let current = start;
	// Initialize week-based cells
	while (Temporal.PlainDate.compare(current, now) <= 0) {
		cells.push({
			target: `${current.toLocaleString(locale, { month: "short", day: "numeric" })} - ${current.add({ days: 6 }).toLocaleString(locale, { month: "short", day: "numeric" })}`,
			contents: []
		});
		current = current.add({ weeks: 1 });
	}

	// Distribute content into week-based cells
	contents.forEach(content => {
		const gap = start.until(content.date, { largestUnit: "week" }).weeks;
		if (gap >= 0 && gap < cells.length) cells[gap].contents.push(content);
	});
} else {
	const weekend = now.add({ days: 7 - now.dayOfWeek });

	const { weeks = 20 } = config.heatmap?.unit === "day" ? config.heatmap : {};
	const start = weekend.subtract({ weeks: weeks - 1, days: 6 });

	let current = start;
	// Initialize day-based cells
	while (Temporal.PlainDate.compare(current, weekend) <= 0) {
		cells.push({ target: current.toLocaleString(locale, { dateStyle: "medium" }), contents: [] });
		current = current.add({ days: 1 });
	}

	// Distribute content into day-based cells
	contents.forEach(content => {
		const gap = start.until(content.date, { largestUnit: "day" }).days;
		if (gap >= 0 && gap < cells.length) cells[gap].contents.push(content);
	});
}

// Helper function to group content by title and activity type
function groupByTitleAndActivity(items: ContentWithActivity[]) {
	const map = new Map<string, { create: boolean; modify: boolean; link: string }>();
	items.forEach(item => {
		if (!map.has(item.title)) {
			map.set(item.title, { create: false, modify: false, link: item.link });
		}
		const entry = map.get(item.title)!;
		if (item.activityType === "create") entry.create = true;
		if (item.activityType === "modify") entry.modify = true;
	});
	return Array.from(map.entries());
}
---

<section class:list={["grid gap-1", { "grid-flow-col grid-rows-7": frequency === "day", "grid-cols-13": frequency === "week", "grid-cols-12": frequency === "month" }]}>
	{
		cells.map(cell => {
			const count = cell.contents.length;
			const details = [];

			// Generate details for the popup based on cell content
			if (count) {
				const notes = cell.contents.filter(content => content.section === "note");
				const jottings = cell.contents.filter(content => content.section === "jotting");

				if (notes.length) {
					if (frequency === "month") {
						const createCount = notes.filter(n => n.activityType === "create").length;
						const modifyCount = notes.filter(n => n.activityType === "modify").length;
						details.push(
							<p>
								{t("home.heatmap.note", { count: notes.length })} (创建: {createCount}, 更新: {modifyCount})
							</p>
						);
					} else {
						details.push(<p class="my-1">{t("home.heatmap.note", { count: notes.length })}：</p>);

						const noteEntries = groupByTitleAndActivity(notes);

						details.push(
							<ul class="flex flex-col gap-0.5">
								{noteEntries.map(entry => {
									const title = entry[0];
									const info = entry[1];
									const badges = [];
									if (info.create) badges.push(<span class="text-[10px] px-1 py-0.5 rounded bg-green-500/20 text-green-600 dark:text-green-400">创建</span>);
									if (info.modify) badges.push(<span class="text-[10px] px-1 py-0.5 rounded bg-blue-500/20 text-blue-600 dark:text-blue-400">修改</span>);

									return (
										<li class="flex items-center gap-1">
											<a href={info.link} aria-label={title} class="ms-1 link flex-1">
												{title}
											</a>
											<span class="flex gap-1">{badges}</span>
										</li>
									);
								})}
							</ul>
						);
					}
				}

				if (jottings.length) {
					if (frequency === "month") {
						const createCount = jottings.filter(j => j.activityType === "create").length;
						const modifyCount = jottings.filter(j => j.activityType === "modify").length;
						details.push(
							<p>
								{t("home.heatmap.jotting", { count: jottings.length })} (创建: {createCount}, 更新: {modifyCount})
							</p>
						);
					} else {
						details.push(<p class="my-1">{t("home.heatmap.jotting", { count: jottings.length })}：</p>);

						const jottingEntries = groupByTitleAndActivity(jottings);

						details.push(
							<ul class="flex flex-col gap-0.5">
								{jottingEntries.map(entry => {
									const title = entry[0];
									const info = entry[1];
									const badges = [];
									if (info.create) badges.push(<span class="text-[10px] px-1 py-0.5 rounded bg-green-500/20 text-green-600 dark:text-green-400">创建</span>);
									if (info.modify) badges.push(<span class="text-[10px] px-1 py-0.5 rounded bg-blue-500/20 text-blue-600 dark:text-blue-400">更新</span>);

									return (
										<li class="flex items-center gap-1">
											<a href={info.link} aria-label={title} class="ms-1 link flex-1">
												{title}
											</a>
											<span class="flex gap-1">{badges}</span>
										</li>
									);
								})}
							</ul>
						);
					}
				}
			} else {
				// Display empty message if no content
				details.push(<p class="mt-1">{t("home.heatmap.empty")}</p>);
			}

			return (
				<figure class="relative group/pop">
					<i class:list={["block bg-primary/10", { "w-2.5 h-2.5": frequency === "day", "w-4 h-4": frequency === "week", "w-4.5 h-4.5": frequency === "month" }, { "bg-primary/40": count > 0, "bg-primary/70": count > 1, "bg-primary": count > 2 }]} />

					<div class="absolute start-0 bottom-full w-max -translate-x-1/2 rtl:translate-x-1/2 flex flex-col mb-1 rounded-sm px-2 py-2 text-xs text-background bg-primary pop">
						<time class="font-bold">{cell.target}</time>
						{details}
					</div>
				</figure>
			);
		})
	}
</section>
